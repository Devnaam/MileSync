// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User authentication and profile
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  firebaseUid       String    @unique
  fullName          String?
  timezone          String    @default("Asia/Kolkata")
  preferredLanguage String    @default("en")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?

  goals              Goal[]
  chatConversations  ChatConversation[]
  progressLogs       ProgressLog[]
  weeklyReviews      WeeklyReview[]
  monthlyMilestones  MonthlyMilestone[]

  @@map("users")
}

// Goals
model Goal {
  id              String    @id @default(uuid())
  userId          String
  title           String
  description     String?
  goalType        GoalType
  status          GoalStatus @default(ACTIVE)
  startDate       DateTime
  targetDate      DateTime
  totalDuration   Int       // Total days
  hoursPerDay     Float     // Daily commitment
  currentProgress Float     @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  context           GoalContext?
  plan              GoalPlan?
  progressLogs      ProgressLog[]
  chatConversations ChatConversation[]
  weeklyReviews     WeeklyReview[]
  monthlyMilestones MonthlyMilestone[]

  @@map("goals")
}

// Goal clarification context
model GoalContext {
  id                 String   @id @default(uuid())
  goalId             String   @unique
  clarificationData  Json     // Stores Q&A pairs
  unavailableTimes   Json?    // User constraints
  preferredSchedule  Json?    // Time preferences
  additionalNotes    String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@map("goal_context")
}

// Hierarchical plan structure
model GoalPlan {
  id                String   @id @default(uuid())
  goalId            String   @unique
  planStructure     Json     // Full month/week/day breakdown
  generatedAt       DateTime @default(now())
  lastModified      DateTime @updatedAt
  version           Int      @default(1)

  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@map("goal_plans")
}

// Daily progress tracking
model ProgressLog {
  id               String    @id @default(uuid())
  userId           String
  goalId           String
  date             DateTime
  tasksCompleted   Json      // Array of completed task IDs
  hoursSpent       Float
  completionRate   Float
  notes            String?
  blockers         String?
  createdAt        DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@unique([goalId, date])
  @@map("progress_logs")
}

// Chat conversations
model ChatConversation {
  id           String   @id @default(uuid())
  userId       String
  goalId       String?
  title        String?
  lastMessage  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal     Goal?         @relation(fields: [goalId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@map("chat_conversations")
}

// Individual chat messages
model ChatMessage {
  id               String   @id @default(uuid())
  conversationId   String
  role             Role
  content          String
  metadata         Json?    // Token count, model version, etc.
  createdAt        DateTime @default(now())

  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

// Weekly progress summaries
model WeeklyReview {
  id                String   @id @default(uuid())
  userId            String
  goalId            String
  weekNumber        Int
  weekStartDate     DateTime
  weekEndDate       DateTime
  totalHoursSpent   Float
  tasksCompleted    Int
  completionRate    Float
  insights          String?
  aiSummary         String?
  createdAt         DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@unique([goalId, weekNumber])
  @@map("weekly_reviews")
}

// Monthly milestone tracking
model MonthlyMilestone {
  id                String   @id @default(uuid())
  userId            String
  goalId            String
  monthNumber       Int
  monthStartDate    DateTime
  monthEndDate      DateTime
  milestoneTitle    String
  status            MilestoneStatus
  completionDate    DateTime?
  notes             String?
  createdAt         DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@unique([goalId, monthNumber])
  @@map("monthly_milestones")
}

// Enums
enum GoalType {
  ACADEMIC
  SKILL
  FITNESS
  CAREER
  CREATIVE
  CUSTOM
}

enum GoalStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum Role {
  USER
  ASSISTANT
  SYSTEM
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
}
